<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>월드컵 토너먼트</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <style>
    /* Reset & Base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Arial', sans-serif; background: #f0f4f8; color: #333; }
    #container { max-width: 600px; margin: 20px auto; padding: 10px; }
    h1 { text-align: center; font-size: 2.5em; color: #005b96; margin-bottom: 0.5em; }
    .section { background: #fff; border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 10px 0; }
    .btn { font-size: 1.2em; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .btn-primary { background: #007bff; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #0056b3; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-success:hover { background: #218838; }
    .btn-secondary { background: #6c757d; color: #fff; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-info { background: #17a2b8; color: #fff; }
    .btn-info:hover { background: #117a8b; }
    input[type=text] { flex: 1; padding: 10px; font-size: 1.1em; border: 2px solid #ccc; border-radius: 8px; }
    ul { list-style: none; margin-top: 10px; }
    ul li { background: #fafafa; border: 1px solid #e0e0e0; padding: 10px; margin-bottom: 6px; border-radius: 6px; font-size: 1.1em; }
    .history-item { display: flex; align-items: center; }
    .history-item img { width: 48px; height: 48px; border-radius: 6px; margin-right: 12px; }
    .history-item .info { flex: 1; }
    .history-item .time { font-size: 0.9em; color: #666; }
  </style>
</head>
<body>
  <div id="container">
    <h1>월드컵 토너먼트</h1>

    <section id="setup" class="section">
      <div class="btn-group" id="listSelector">
        <button class="btn btn-success" data-list="new">NEW</button>
        <button class="btn btn-primary" data-list="1">리스트1</button>
        <button class="btn btn-primary" data-list="2">리스트2</button>
      </div>
      <p>항목 개수 선택:</p>
      <div class="btn-group" id="sizeSelector">
        <button class="btn btn-success" data-size="4">4</button>
        <button class="btn btn-primary" data-size="8">8</button>
        <button class="btn btn-primary" data-size="16">16</button>
        <button class="btn btn-primary" data-size="32">32</button>
        <button class="btn btn-primary" data-size="64">64</button>
        <button class="btn btn-primary" data-size="128">128</button>
      </div>
      <p id="itemCountInfo">0/4 항목 추가됨 (NEW)</p>
      <div class="btn-group" style="display:flex;">
        <input type="text" id="singleInput" placeholder="항목명을 입력하세요" />
        <button id="addBtn" class="btn btn-primary" style="margin-left:10px;">추가</button>
      </div>
      <div class="btn-group">
        <button id="startBtn" class="btn btn-primary" disabled>시작</button>
        <button id="resetBtn" class="btn btn-secondary">초기화</button>
        <button id="shareLinkBtn" class="btn btn-info">링크 공유</button>
      </div>
      <div class="btn-group">
        <button id="saveList1Btn" class="btn btn-primary" disabled>리스트1 저장</button>
        <button id="saveList2Btn" class="btn btn-primary" disabled>리스트2 저장</button>
      </div>
    </section>

    <section id="round" class="section" style="display:none;">
      <p id="roundInfo"></p>
      <div class="btn-group">
        <button class="btn btn-primary option-btn" id="optA"></button>
        <button class="btn btn-primary option-btn" id="optB"></button>
      </div>
    </section>

    <section id="result" class="section" style="display:none;">
      <p id="finalText" style="font-size:1.3em; font-weight:bold;"></p>
      <button id="homeBtn" class="btn btn-success">처음으로 가기</button>
    </section>

    <section id="history" class="section">
      <h2>최근 결과</h2>
      <ul id="historyList"></ul>
    </section>
  </div>

  <!-- 모달 오버레이 -->
  <div id="modalOverlay" style="display:none; align-items:center; justify-content:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
    <div id="modal" class="section" style="max-width:300px; margin:auto;">
      <h2>축하합니다!</h2>
      <p id="modalText" style="font-size:1.2em;"></p>
      <div class="btn-group">
        <button id="shareModalBtn" class="btn btn-info">결과 저장</button>
        <button id="closeModal" class="btn btn-secondary">닫기</button>
      </div>
    </div>
  </div>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', function() {
      // 클릭 사운드
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      function playClick() {
        const ctx = audioCtx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = 'sine'; osc.frequency.value = 600;
        const now = ctx.currentTime;
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.25, now + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
      }
      document.querySelectorAll('button').forEach(btn => btn.addEventListener('click', playClick));
      document.getElementById('singleInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault(); document.getElementById('addBtn').click();
        }
      });

      // 저장 키
      const storageKey = 'worldcupstorage';
      const historyKey = 'worldcupHistory';
      const wsData = JSON.parse(localStorage.getItem(storageKey) || '{}');
      let currentList = 'new', bracketSize = 4;
      let items = [], current = [], nextRound = [];
      let idx = 0, roundNum = 1;

      // 엘리먼트 참조
      const listGroup     = document.getElementById('listSelector');
      const sizeGroup     = document.getElementById('sizeSelector');
      const itemCountInfo = document.getElementById('itemCountInfo');
      const singleInput   = document.getElementById('singleInput');
      const addBtn        = document.getElementById('addBtn');
      const resetBtn      = document.getElementById('resetBtn');
      const shareLinkBtn  = document.getElementById('shareLinkBtn');
      const save1Btn      = document.getElementById('saveList1Btn');
      const save2Btn      = document.getElementById('saveList2Btn');
      const startBtn      = document.getElementById('startBtn');
      const itemList      = document.getElementById('itemList');
      const setupSec      = document.getElementById('setup');
      const roundSec      = document.getElementById('round');
      const resultSec     = document.getElementById('result');
      const roundInfoElem = document.getElementById('roundInfo');
      const optA          = document.getElementById('optA');
      const optB          = document.getElementById('optB');
      const finalText     = document.getElementById('finalText');
      const homeBtn       = document.getElementById('homeBtn');
      const modalOverlay  = document.getElementById('modalOverlay');
      const modalText     = document.getElementById('modalText');
      const closeModalBtn = document.getElementById('closeModal');
      const shareModalBtn = document.getElementById('shareModalBtn');
      const historyList   = document.getElementById('historyList');

      // 헬퍼 함수
      const saveStorage = () => localStorage.setItem(storageKey, JSON.stringify(wsData));
      const getHistory  = () => JSON.parse(localStorage.getItem(historyKey) || '[]');
      function renderHistory() {
        const history = getHistory().slice(0, 10);
        historyList.innerHTML = '';
        history.forEach(entry => {
          const li = document.createElement('li');
          li.className = 'history-item';
          li.innerHTML = `
            <img src="${entry.image}" alt="결과">
            <div class="info">
              <div>${entry.result}</div>
              <div class="time">${new Date(entry.time).toLocaleString()}</div>
            </div>`;
          historyList.appendChild(li);
        });
      }
      function updateUI() {
        itemList.innerHTML = ''; items.forEach(v => itemList.insertAdjacentHTML('beforeend', `<li>${v}</li>`));
        itemCountInfo.textContent = `${items.length}/${bracketSize} 항목 추가됨 (${currentList.toUpperCase()})`;
        const isNew = currentList === 'new';
        [singleInput, addBtn, resetBtn, save1Btn, save2Btn].forEach(el => el.disabled = !isNew);
        startBtn.disabled = items.length !== bracketSize;
        save1Btn.disabled = !isNew || items.length !== bracketSize;
        save2Btn.disabled = !isNew || items.length !== bracketSize;
      }
      function loadItems() {
        const listData = wsData[currentList] || {};
        items = Array.isArray(listData[bracketSize]) ? [...listData[bracketSize]] : [];
        updateUI();
        toggleGroup(listGroup, 'list', currentList);
        toggleGroup(sizeGroup, 'size', `${bracketSize}`);
      }
      function toggleGroup(group, key, val) {
        Array.from(group.children).forEach(btn => btn.classList.toggle('selected', btn.dataset[key] === val));
      }
      const shuffle = arr => arr.sort(() => Math.random() - 0.5);

      // 이벤트 바인딩
      listGroup.addEventListener('click', e => { if(e.target.dataset.list){ currentList=e.target.dataset.list; if(currentList==='new') wsData.new = wsData.new||{}; loadItems(); }});
      sizeGroup.addEventListener('click', e => { if(e.target.dataset.size){ bracketSize=+e.target.dataset.size; loadItems(); }});
      addBtn.addEventListener('click', ()=>{ const v=singleInput.value.trim(); if(!v||items.length>=bracketSize) return; items.push(v); wsData[currentList]=wsData[currentList]||{}; wsData[currentList][bracketSize]=[...items]; saveStorage(); singleInput.value=''; updateUI(); });
      resetBtn.addEventListener('click', ()=>{ localStorage.removeItem(storageKey); localStorage.removeItem(historyKey); Object.keys(wsData).forEach(k=>delete wsData[k]); currentList='new'; bracketSize=4; loadItems(); setupSec.style.display=''; roundSec.style.display='none'; resultSec.style.display='none'; });
      [save1Btn, save2Btn].forEach((btn,i)=>btn.addEventListener('click', ()=>{ const key=`${i+1}`; wsData[key]=wsData[key]||{}; wsData[key][bracketSize]=[...items]; saveStorage(); alert(`리스트${key}에 저장되었습니다.`); }));
      startBtn.addEventListener('click', ()=>{ current=[...items]; shuffle(current); setupSec.style.display='none'; roundSec.style.display=''; idx=0;roundNum=1;nextRound=[]; showPair(); });
      function showPair(){ if(current.length===1) return showResult(current[0]); roundInfoElem.textContent=`Round ${roundNum}: ${current.length}→${current.length/2}`; optA.textContent=current[idx]; optB.textContent=current[idx+1]; }
      [optA,optB].forEach(btn=>btn.addEventListener('click', ()=>{ nextRound.push(btn.textContent); idx+=2; if(idx>=current.length){ current=[...nextRound]; nextRound=[]; idx=0; roundNum++; } showPair(); }));
      function showResult(final){ roundSec.style.display='none'; resultSec.style.display=''; finalText.textContent=`최종 선택된 항목: ${final}`; modalText.textContent=finalText.textContent; modalOverlay.style.display='flex'; launchConfetti(); }
      homeBtn.addEventListener('click', ()=>{ modalOverlay.style.display='none'; resultSec.style.display='none'; setupSec.style.display=''; }); closeModalBtn.addEventListener('click', ()=>modalOverlay.style.display='none');
      shareLinkBtn.addEventListener('click', async()=>{ try{ if(navigator.share){ await navigator.share({ title:'월드컵 토너먼트', url:location.href }); } else{ await navigator.clipboard.writeText(location.href); alert('링크가 클립보드에 복사되었습니다.'); }}catch(e){ console.error(e); alert('공유에 실패했습니다.'); }});
      shareModalBtn.addEventListener('click', async()=>{ try{ const canvas=await html2canvas(document.getElementById('modal')); const dataURL=canvas.toDataURL('image/png'); const history=getHistory(); history.unshift({ time:new Date().toISOString(), result:modalText.textContent, image:dataURL }); localStorage.setItem(historyKey,JSON.stringify(history)); const link=document.createElement('a'); link.href=dataURL; link.download=`월드컵_결과_${new Date().toISOString()}.png`; document.body.appendChild(link); link.click(); document.body.removeChild(link); renderHistory(); }catch(err){ console.error(err); alert('결과 저장 중 오류가 발생했습니다.'); }});
      function launchConfetti(){ for(let i=0;i<50;i++){ const conf=document.createElement('div'); conf.className='confetti-piece'; conf.style.backgroundColor=`hsl(${Math.random()*360},100%,50%)`; conf.style.left=`${Math.random()*100}vw`; conf.style.animationDuration=`${2+Math.random()*2}s`; document.body.appendChild(conf); conf.addEventListener('animationend',()=>conf.remove()); }}
      renderHistory(); loadItems();
    });
    if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('/sw.js').catch(console.error); }); }
  </script>
</body>
</html>
